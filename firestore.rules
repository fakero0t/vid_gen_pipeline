rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================================
    // Users Collection
    // =========================================================================
    
    // User-specific data - users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // User's projects - only they can read/write
      match /projects/{projectId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      
      // User's assets - only they can read/write
      match /assets/{assetId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        
        // Ensure user_id field matches the user accessing it
        allow create: if request.auth != null && 
                        request.auth.uid == userId &&
                        request.resource.data.user_id == userId;
        
        allow update: if request.auth != null && 
                        request.auth.uid == userId &&
                        resource.data.user_id == userId;
      }
    }
    
    // =========================================================================
    // Storyboards Collection
    // =========================================================================
    
    // Storyboards - currently open to all authenticated users
    // TODO: Add user ownership validation once we link storyboards to users
    match /storyboards/{storyboardId} {
      allow read, write: if request.auth != null;
    }
    
    // =========================================================================
    // Scenes Collection
    // =========================================================================
    
    // Scenes - currently open to all authenticated users
    // TODO: Add user ownership validation via storyboard ownership
    match /scenes/{sceneId} {
      allow read, write: if request.auth != null;
    }
    
    // =========================================================================
    // Collection Group Queries
    // =========================================================================
    
    // Allow collection group queries on assets (used by backend for lookups)
    // Security is enforced by the individual document rules above
    match /{path=**}/assets/{assetId} {
      allow read: if request.auth != null;
    }
  }
}

